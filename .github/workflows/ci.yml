name: Continuous Integration

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  DART_VERSION: "3.2.0"
  NODE_VERSION: "18.x"
  PYTHON_VERSION: "3.11"
  GO_VERSION: "1.21"

jobs:
  # Проверка качества кода
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Dart
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.16.0"
          channel: "stable"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}

      # Dart/Flutter проверки
      - name: Install Flutter dependencies
        run: flutter pub get

      - name: Analyze Dart code
        run: flutter analyze

      - name: Check Dart formatting
        run: dart format --output=none --set-exit-if-changed .

      - name: Run Dart tests
        run: flutter test

      # Node.js проверки
      - name: Install Node.js dependencies
        run: |
          cd api/sdks/javascript
          npm ci

      - name: Lint JavaScript/TypeScript
        run: |
          cd api/sdks/javascript
          npm run lint

      - name: Run JavaScript tests
        run: |
          cd api/sdks/javascript
          npm test

      # Python проверки
      - name: Install Python dependencies
        run: |
          cd api/sdks/python
          pip install -r requirements-dev.txt

      - name: Lint Python code
        run: |
          cd api/sdks/python
          flake8 src/
          black --check src/
          isort --check-only src/

      - name: Run Python tests
        run: |
          cd api/sdks/python
          pytest tests/ --cov=src/ --cov-report=xml

      # Go проверки
      - name: Install Go dependencies
        run: |
          cd api/sdks/go
          go mod download

      - name: Lint Go code
        run: |
          cd api/sdks/go
          golangci-lint run

      - name: Run Go tests
        run: |
          cd api/sdks/go
          go test -v -race -coverprofile=coverage.out ./...

      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          files: |
            api/sdks/python/coverage.xml
            api/sdks/go/coverage.out
          fail_ci_if_error: false

  # Сборка приложения
  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: code-quality
    strategy:
      matrix:
        platform: [linux, windows, macos]
        architecture: [x64, arm64]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.16.0"
          channel: "stable"

      - name: Install dependencies
        run: flutter pub get

      - name: Build Flutter app
        run: |
          flutter build linux --release
          flutter build windows --release
          flutter build macos --release

      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: katya-build-${{ matrix.platform }}-${{ matrix.architecture }}
          path: |
            build/linux/
            build/windows/
            build/macos/
          retention-days: 30

  # Сборка Docker образов
  docker-build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: code-quality

    strategy:
      matrix:
        service: [api, web, mobile, analytics, security]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: katya/${{ matrix.service }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/${{ matrix.service }}/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # GDPR Compliance Check
  gdpr-compliance:
    name: GDPR Compliance
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for personal data handling
        run: |
          # Run GDPR compliance checks
          echo "Checking for GDPR compliance..."
          # Add checks for data minimization, consent, etc.

      - name: Privacy audit
        run: |
          # Run privacy audit
          echo "Running privacy audit..."

  # Безопасность
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: code-quality

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "sarif"
          output: "trivy-results.sarif"

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: "trivy-results.sarif"

      - name: Run CodeQL Analysis
        uses: github/codeql-action/analyze@v2
        with:
          languages: javascript, python, go

  # Интеграционные тесты
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [build, docker-build, gdpr-compliance, security]

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: katya_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

      elasticsearch:
        image: docker.elastic.co/elasticsearch/elasticsearch:8.8.0
        env:
          discovery.type: single-node
          xpack.security.enabled: false
        options: >-
          --health-cmd "curl -f http://localhost:9200/_cluster/health || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 9200:9200

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup test environment
        run: |
          cp .env.example .env.test
          echo "DATABASE_URL=postgresql://postgres:postgres@localhost:5432/katya_test" >> .env.test
          echo "REDIS_URL=redis://localhost:6379" >> .env.test
          echo "ELASTICSEARCH_URL=http://localhost:9200" >> .env.test

      - name: Run database migrations
        run: |
          docker run --rm --network host \
            -v $(pwd):/app \
            -w /app \
            node:18 \
            npm run migrate:test

      - name: Run integration tests
        run: |
          npm run test:integration

      - name: Upload test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: integration-test-results
          path: |
            test-results/
            coverage/
          retention-days: 30

  # E2E тесты
  e2e-tests:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    needs: [docker-build, integration-tests]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Start services with Docker Compose
        run: |
          docker-compose -f docker-compose.test.yml up -d
          sleep 30

      - name: Wait for services to be ready
        run: |
          npx wait-on http://localhost:3000/health
          npx wait-on http://localhost:3001/health

      - name: Run E2E tests
        run: |
          npm run test:e2e

      - name: Upload E2E test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: e2e-test-results
          path: |
            e2e-results/
            screenshots/
          retention-days: 30

      - name: Stop services
        if: always()
        run: docker-compose -f docker-compose.test.yml down

  # Производительность
  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    needs: [integration-tests]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Start services
        run: |
          docker-compose -f docker-compose.test.yml up -d
          sleep 60

      - name: Run load tests
        run: |
          npm run test:load

      - name: Run stress tests
        run: |
          npm run test:stress

      - name: Upload performance results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: performance-test-results
          path: |
            load-test-results/
            stress-test-results/
          retention-days: 30

      - name: Stop services
        if: always()
        run: docker-compose -f docker-compose.test.yml down

  # Уведомления
  notify:
    name: Notify Results
    runs-on: ubuntu-latest
    needs:
      [
        code-quality,
        build,
        docker-build,
        gdpr-compliance,
        security,
        integration-tests,
        e2e-tests,
        performance-tests,
      ]
    if: always()

    steps:
      - name: Notify Slack
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: "#ci-cd"
          text: |
            CI/CD Pipeline completed for ${{ github.ref_name }}

            Results:
            - Code Quality: ${{ needs.code-quality.result }}
            - Build: ${{ needs.build.result }}
            - Docker: ${{ needs.docker-build.result }}
            - GDPR Compliance: ${{ needs.gdpr-compliance.result }}
            - Security: ${{ needs.security.result }}
            - Integration Tests: ${{ needs.integration-tests.result }}
            - E2E Tests: ${{ needs.e2e-tests.result }}
            - Performance: ${{ needs.performance-tests.result }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
